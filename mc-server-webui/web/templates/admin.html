{{define "title"}}Admin Dashboard{{end}}

{{define "content"}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Server Management</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
      + Add Server
    </button>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-sm align-middle">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">Name</th>
        <th scope="col">Address</th>
        <th scope="col">State</th>
        <th scope="col">Show MOTD</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {{range .Servers}}
      <tr>
        <td>{{.ID}}</td>
        <td>{{.Name}}</td>
        <td>{{.Address}}</td>
        <td>
          {{if eq .State "online"}}<span class="badge bg-success">Online</span>{{end}}
          {{if eq .State "offline"}}<span class="badge bg-secondary">Offline</span>{{end}}
          {{if eq .State "planned"}}<span class="badge bg-info text-dark">Planned</span>{{end}}
          {{if eq .State "maintenance"}}<span class="badge bg-warning text-dark">Maintenance</span>{{end}}
        </td>
        <td>{{if .ShowMOTD}}✅{{else}}❌{{end}}</td>
        <td>
          <a href="/admin/files/{{.Name}}" class="btn btn-sm btn-outline-info me-1">Files</a>
          <button class="btn btn-sm btn-outline-primary" 
            data-bs-toggle="modal" 
            data-bs-target="#editServerModal"
            data-id="{{.ID}}"
            data-name="{{.Name}}"
            data-address="{{.Address}}"
            data-description="{{.Description}}"
            data-bluemap="{{.BlueMapURL}}"
            data-modpack="{{.ModpackURL}}"
            data-state="{{.State}}"
            data-showmotd="{{.ShowMOTD}}"
            data-metadata='{{.Metadata | json}}'>
            Edit
          </button>
          <form action="/admin/servers/delete" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete {{.Name}}?');">
            <input type="hidden" name="id" value="{{.ID}}">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
</div>

<div class="mt-5 text-muted small">
  <p>Logged in as: <strong>{{.UserEmail}}</strong></p>
</div>

<!-- Add Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/admin/servers/add" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Add New Server</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addName" class="form-label">Name (Unique ID)</label>
            <input type="text" class="form-control" id="addName" name="name" required pattern="[a-zA-Z0-9_-]+" title="Alphanumeric, dashes, underscores only">
          </div>
          <div class="mb-3">
            <label for="addAddress" class="form-label">Server Address</label>
            <input type="text" class="form-control" id="addAddress" name="address" required>
          </div>
          <div class="mb-3">
            <label for="addDescription" class="form-label">Description</label>
            <textarea class="form-control" id="addDescription" name="description" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="addState" class="form-label">State</label>
              <select class="form-select" id="addState" name="state">
                <option value="online" selected>Online</option>
                <option value="offline">Offline</option>
                <option value="planned">Planned</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
            <div class="col-md-6 mb-3 pt-4">
               <div class="form-check">
                <input class="form-check-input" type="checkbox" id="addShowMOTD" name="show_motd" checked>
                <label class="form-check-label" for="addShowMOTD">Show MOTD</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="addBlueMap" class="form-label">BlueMap URL</label>
            <input type="url" class="form-control" id="addBlueMap" name="blue_map_url">
          </div>
          <div class="mb-3">
            <label for="addModpack" class="form-label">Modpack URL</label>
            <input type="text" class="form-control" id="addModpack" name="modpack_url">
          </div>
          <div class="mb-3">
            <label class="form-label">Metadata</label>
            <div id="addMetadataContainer"></div>
            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addMetadataRow('addMetadataContainer')">+ Add Property</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Server</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Server Modal -->
<div class="modal fade" id="editServerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/admin/servers/update" method="POST">
        <input type="hidden" name="id" id="editId">
        <div class="modal-header">
          <h5 class="modal-title">Edit Server</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editName" class="form-label">Name (Unique ID)</label>
            <input type="text" class="form-control" id="editName" name="name" required pattern="[a-zA-Z0-9_-]+" title="Alphanumeric, dashes, underscores only">
          </div>
          <div class="mb-3">
            <label for="editAddress" class="form-label">Server Address</label>
            <input type="text" class="form-control" id="editAddress" name="address" required>
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" name="description" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editState" class="form-label">State</label>
              <select class="form-select" id="editState" name="state">
                <option value="online">Online</option>
                <option value="offline">Offline</option>
                <option value="planned">Planned</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
            <div class="col-md-6 mb-3 pt-4">
               <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editShowMOTD" name="show_motd">
                <label class="form-check-label" for="editShowMOTD">Show MOTD</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="editBlueMap" class="form-label">BlueMap URL</label>
            <input type="url" class="form-control" id="editBlueMap" name="blue_map_url">
          </div>
          <div class="mb-3">
            <label for="editModpack" class="form-label">Modpack URL</label>
            <input type="text" class="form-control" id="editModpack" name="modpack_url">
          </div>
          <div class="mb-3">
            <label class="form-label">Metadata</label>
            <div id="editMetadataContainer"></div>
            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addMetadataRow('editMetadataContainer')">+ Add Property</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function addMetadataRow(containerId, key = '', value = '') {
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
      <input type="text" class="form-control" name="meta_key" placeholder="Key" value="${key}">
      <input type="text" class="form-control" name="meta_value" placeholder="Value" value="${value}">
      <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button>
    `;
    container.appendChild(div);
  }

  // Populate Edit Modal
  var editModal = document.getElementById('editServerModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    
    document.getElementById('editId').value = button.getAttribute('data-id');
    document.getElementById('editName').value = button.getAttribute('data-name');
    document.getElementById('editAddress').value = button.getAttribute('data-address');
    document.getElementById('editDescription').value = button.getAttribute('data-description');
    document.getElementById('editBlueMap').value = button.getAttribute('data-bluemap');
    document.getElementById('editModpack').value = button.getAttribute('data-modpack');
    document.getElementById('editState').value = button.getAttribute('data-state');
    document.getElementById('editShowMOTD').checked = button.getAttribute('data-showmotd') === 'true';

    // Populate metadata
    const container = document.getElementById('editMetadataContainer');
    container.innerHTML = '';
    const metadata = JSON.parse(button.getAttribute('data-metadata'));
    if (metadata) {
      for (const [key, value] of Object.entries(metadata)) {
        addMetadataRow('editMetadataContainer', key, value);
      }
    }
  });
</script>
{{end}}