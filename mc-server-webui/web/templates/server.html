{{define "title"}}{{.Server.Name}} - Details{{end}}

{{define "content"}}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{.Server.Name}}</li>
  </ol>
</nav>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="card-title mb-0">{{.Server.Name}}</h1>
          <div class="server-status-poller h5 mb-0" data-server="{{.Server.Name}}">Checking status...</div>
        </div>
        <h6 class="text-muted">{{.Server.Address}}</h6>
        <p class="card-text lead">{{.Server.Description | nl2br}}</p>

        {{if .Server.ModpackURL}}
        <a href="{{.Server.ModpackURL}}" class="btn btn-success mb-3">Download Modpack</a>
        {{end}}

        {{if .Server.BlueMapURL}}
        <h4 class="mt-4">Live Map</h4>
        <div class="ratio ratio-16x9 border rounded">
          <iframe src="/{{.Server.Name}}/map/" title="BlueMap" allowfullscreen></iframe>
        </div>
        {{end}}
      </div>
    </div>
    
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        File Browser
      </div>
      <div class="card-body">
        <div id="file-browser">Loading files...</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        Server Info
      </div>
      <ul class="list-group list-group-flush">
         <li class="list-group-item d-flex justify-content-between align-items-center">
            <strong>Address</strong> <span>{{.Server.Address}}</span>
         </li>
         {{range $k, $v := .Server.Metadata}}
         <li class="list-group-item d-flex justify-content-between align-items-center">
            <strong>{{$k}}</strong> <span>{{$v}}</span>
         </li>
         {{end}}
         <li class="list-group-item">
            <strong>Online Players</strong>
            <div id="player-list-{{.Server.Name}}" class="small mt-1 text-muted">No players online</div>
         </li>
      </ul>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const serverName = "{{.Server.Name}}";
    const container = document.getElementById('file-browser');
    
    fetch(`/api/servers/${serverName}/mods`)
    .then(r => {
        if (!r.ok) throw new Error("No files found or server error");
        return r.json();
    })
    .then(data => {
      container.innerHTML = renderFileTree(data, serverName);
    })
    .catch(e => {
      container.innerHTML = `<div class="alert alert-warning">${e.message}</div>`;
    });
});

// Reusing the render logic (could be moved to base.html if shared)
function renderFileTree(item, serverName) {
  let html = '<ul class="list-group list-group-flush">';
  if (item.path === "") {
     if (!item.children || item.children.length === 0) return "No files found.";
     return renderChildren(item.children, serverName);
  }
  return "Error: Root expected";
}

function renderChildren(children, serverName) {
    let html = '<ul class="list-group">';
    children.forEach(child => {
        let icon = child.type === 'directory' ? 'ğŸ“' : 'ğŸ“„';
        if (child.type === 'url') icon = 'ğŸ”—';
        
        let content = '';
        if (child.type === 'directory') {
            content = `
            <details>
                <summary class="list-group-item list-group-item-action">
                    ${icon} ${child.name}
                </summary>
                <div class="ms-4">
                    ${child.children ? renderChildren(child.children, serverName) : ''}
                </div>
            </details>`;
        } else if (child.type === 'url') {
            content = `<a href="${child.url}" target="_blank" class="list-group-item list-group-item-action text-primary">${icon} ${child.name}</a>`;
        } else {
             const downloadPath = `/files/${serverName}/mods/${child.path}`;
             content = `<a href="${downloadPath}" target="_blank" class="list-group-item list-group-item-action">${icon} ${child.name} <span class="badge bg-light text-dark float-end">${formatBytes(child.size)}</span></a>`;
        }
        html += content;
    });
    html += '</ul>';
    return html;
}

function formatBytes(bytes, decimals = 2) {
    if (!+bytes) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}
</script>
{{end}}
